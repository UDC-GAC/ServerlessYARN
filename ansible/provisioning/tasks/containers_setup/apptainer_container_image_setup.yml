## TODO: if base image is created but children images already exist, delete them and re-create them
- name: Image creation ({{ item }})
  delegate_to: localhost
  run_once: yes
  tags: create_app, setup_hdfs
  vars:
    ## item in this context is 'app_type'
    - definition_file: "{{ app_mapping[item]['definition_file'] }}"
    - image_file: "{{ app_mapping[item]['image'] }}"
    - app_base_type: "{{ app_mapping[item]['image_dependency'] if 'image_dependency' in app_mapping[item] }}"
    - app_base_image_file: "{{ app_mapping[app_base_type]['image'] if app_base_type is not none }}" # will be used in the definition image templates
    - extra_files_directory: "apps/{{ app_mapping[item]['install_extra_files'] if 'install_extra_files' in app_mapping[item] }}" # directory on server with the app configuration, relative to 'ansible/provisioning'
    - installed_app_directory: "{{ installation_path }}/apps/{{ app_dir|basename if item == 'generic_app' else item }}" # installation path of app on server
  block:
    - name: Check if app image already exists ({{ item }})
      stat:
        path: "{{ installed_app_directory }}/{{ image_file }}"
        get_checksum: false
        get_mime: false
        get_attributes: false
      register: stat_server_image_output

    - name: Create app image ({{ item }})
      when: not stat_server_image_output.stat.exists
      block:
        - name: Create app directory in server ({{ item }})
          file:
            path: "{{ installed_app_directory }}"
            state: directory

        - name: Copy app definition file ({{ item }})
          template:
            src: "templates/apps/{{ definition_file }}"
            dest: "{{ installed_app_directory }}/{{ definition_file }}"

        ## Copy other files
        # Install script
        - name: Copy app install script if applicable ({{ item }})
          when: install_script is defined and install_script != '' and item == 'generic_app'
          template:
            src: "{{ extra_files_directory }}/{{ install_script }}"
            dest: "{{ installed_app_directory }}/"

        # Optional files directory
        - name: Copy files from optional directory if applicable ({{ item }})
          when: install_files is defined and install_files != '' and item == 'generic_app'
          block:
            - name: Copy app optional files directory ({{ item }})
              copy:
                src: "{{ extra_files_directory }}/{{ install_files }}"
                dest: "{{ installed_app_directory }}/"

            - name: Find config files to template in the app directory ({{ item }})
              find:
                paths: "{{ extra_files_directory }}/{{ install_files }}"
                recurse: yes
              register: found_config_files

            - name: Process template for each config file ({{ item }})
              template:
                src: "{{ file.path }}"
                dest: "{{ installed_app_directory }}/{{ install_files }}/{{ file.path | regex_replace('^' + extra_files_directory + '/' + install_files, '') }}"
              loop: "{{ found_config_files.files }}"
              loop_control:
                loop_var: file ## we need to change this inner loop variable to avoid collisions re-using the 'item' variable from the outer loop

        # Hadoop files
        - name: Copy necessary files for hadoop apps ({{ item }})
          when: "item == 'hadoop_app'"
          copy:
            src: "{{ extra_files_directory }}/{{ file }}"
            dest: "{{ installed_app_directory }}/"
          with_items:
            - setup.sh
            - java_snitch.sh
            - hadoop_files
          loop_control:
            loop_var: file

        - name: Build app image ({{ item }})
          shell: "{{ singularity_command_alias }} build {{ installed_app_directory }}/{{ image_file }} {{ installed_app_directory }}/{{ definition_file }}"
          args:
            chdir: "{{ installed_app_directory }}/../.." ## equivalent to installation_path
            executable: /bin/bash
            creates: "{{ installed_app_directory }}/{{ image_file }}"
